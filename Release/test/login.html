<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width,initial-scale=1,user-scalable=0'>
  <link rel='stylesheet' href='./css/weui-v1.1.3.css'>
  <link rel='stylesheet' href='./css/index.css'>
  <meta http-equiv='X-UA-Compatible' content='ie=edge'>
  <title>登录并绑定</title>
</head>

<body>
  <div class='account-container'>
    <a class='btn-account' href='./signup.html'>去注册</a>

    <div class='logo-panel'>
      <img src='./images/logo_m.png' alt=''>
      <p>绑定和目语音助手 享受智能家居生活</p>
    </div>

    <div class='auth-wrapper'>

      <div id='phoneNumber' class='auth-item'>
        <div class='title'>手机号</div>
        <div class='input'>
          <input type='text' placeholder="请输入手机号码">
        </div>
        <div class='error-tip'></div>
      </div>

      <div id='password' class='auth-item'>
        <div class='title'>密码</div>
        <div class='input'>
          <input type='password' placeholder='6~20位数字和字母的组合'>
        </div>
        <img id='eyes' class='btn-eye' src='./images/common_eye.png' alt=''>
        <div class='error-tip'></div>
      </div>

    </div>
    <div id='login' class='btn-primary'>
      登录并绑定
    </div>
  </div>
</body>

<script type="text/javascript" src="./js/lib/weui-v1.1.4.min.js"></script>
<script type="text/javascript" src="./js/lib/zepto-v1.2.0.min.js"></script>
<script type='text/javascript' src='./js/lib/fontSize.js'></script>
<script type='text/javascript' src='./js/lib/md5-v1.1.0.min.js'></script>
<script type='text/javascript' src='./js/config.js'></script>
<script type='text/javascript' src='./js/modules.js'></script>
<script>
  $(function () {
    var phoneNumberAuth = $('#phoneNumber .input input');
    var passwordAuth = $('#password .input input');

    tools.addTogglePdVisibleEvent('eyes');
    tools.toggleBtnDisable(true);

    var deviceSn = cookie.getCookie('device_sn');

    /******************** 表单校验 Start ********************/
    var pnReady = false;
    var pdReady = false;
    function verifyPhone(value) {
      if (!tools.verifyPhone(value)) {
        pnReady = false;
        tools.toggleBtnDisable(true);
        tools.toggleErrorTip('phoneNumber', true, '请填写正确格式手机号码!');
      } else {
        pnReady = true;
        if (pdReady && pnReady) {
          tools.toggleBtnDisable(false);
        }

        tools.toggleErrorTip('phoneNumber', false);
      }
    }
    function verifyPassword(value) {
      if (!tools.verifyPassword(value)) {
        pdReady = false;
        tools.toggleBtnDisable(true);
        tools.toggleErrorTip('password', true, '请填写6~20位数字和字母组合!');
      } else {
        pdReady = true;

        if (pdReady && pnReady) {
          tools.toggleBtnDisable(false);
        }
        tools.toggleErrorTip('password', false);
      }
    }

    phoneNumberAuth.on('keyup', function (e) {
      var value = e.currentTarget.value;
      verifyPhone(value);
    })
    phoneNumberAuth.on('blur', function (e) {
      var value = e.currentTarget.value;
      verifyPhone(value);
    })

    passwordAuth.on('keyup', function (e) {
      var value = e.currentTarget.value;
      verifyPassword(value);
    })
    passwordAuth.on('blur', function (e) {
      var value = e.currentTarget.value;
      verifyPassword(value);
    })
    /******************** 表单校验 End ********************/

    /******************** 点击登录 Start ********************/
    $('#login').on('click', function () {
      if ($(this).hasClass('disable')) {
        return;
      }

      var phoneNumber = phoneNumberAuth.val();
      var password = passwordAuth.val();

      // 隐藏所有错误提示
      tools.toggleErrorTip('phoneNumber', false);
      tools.toggleErrorTip('password', false);

      // 发起登录请求
      oldAjax.login(phoneNumber, password, function (res) {
        switch (res.result) {
          // 登录成功
          case 0:
            cookie.setCookie('hejia_token', res.data.token);
            cookie.setCookie('hejia_userid', res.data.userid);

            // 绑定设备
            oldAjax.mcbind(res.data.userid, res.data.token, deviceSn, function (_res) {
              switch (_res.result) {
                // -314 当前用户已经绑定
                case -314:
                  window.location.href = './index.html';
                  break;
                // 0 绑定成功
                case 0:
                  window.location.href = './index.html';
                  break;
                case -416:
                  weui.topTips('设备上报配网结果错误!');
                  break;
                case -316:
                  weui.topTips('设备已有其他用户绑定!');
                  break;
                case -315:
                  weui.topTips('绑定失败!');
                  break;
                default:
                  weui.topTips('绑定失败!');
                  break;
              }
            });
            break
          case -111:
            tools.toggleErrorTip('password', true, '密码错误!');
            break;
          case -110:
            tools.toggleErrorTip('phoneNumber', true, '用户不存在!');
            break;
          default:
            weui.topTips('登录失败!');
            break;
        }
      })
    })
  })
  /******************** 点击登录 End ********************/
</script>

</html>
